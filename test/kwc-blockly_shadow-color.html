<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, minimum-scale=1, initial-scale=1, user-scalable=yes">

    <title>kwc-blockly test</title>

    <script src="../../webcomponentsjs/webcomponents-lite.js"></script>
    <script src="../../web-component-tester/browser.js"></script>
    <script src="../../iron-test-helpers/mock-interactions.js"></script>

  <script src="../../../@webcomponents/webcomponentsjs/webcomponents-bundle.js"></script>    <script src="../../../@polymer/iron-test-helpers/mock-interactions.js" type="module"></script>script src="../blockly_built/msg/js/en.js"></script>
    <script src="../blockly_built/javascript_compressed.js"></script>
    <script src="../blockly_built/blockly_compressed.js"></script>script src="../blockly_built/blocks_compressed.js"></script>ript>javascript_compressed.js"></script> </style>
</head>

<body>
    <test-fixture id="basic">
        <template>
            <kwc-blockly></kwc-blockly>
        </template>
    </test-fixture>

    <test-fixture id="shadow-workspace">
        <template>
            <kwc-blockly shadow-light="0.3"></kwc-blockly>
        </template>
    </test-fixture>

    <script>

        const BLOCK_ID = 'block';
        const SHADOW_ID = 'shadow';

        const XML = 
`
<xml<script type="module">
import '../kwc-blockly.js';

const BLOCK_ID = 'block';
const SHADOW_ID = 'shadow';

const XML = 
`
<xml>
<block id="${BLOCK_ID}" type="math_arithmetic">
<value name="A">
    <shadow id="${SHADOW_ID}" type="math_number"></shadow>
</value>
</block>
</xml>
`;

function getBlockFill (block) {
    var blockRoot = block.getSvgRoot(),
        blockPath = blockRoot.querySelector('.blocklyPath');
    return blockPath.getAttribute('fill');
}

function assertShadowColor (workspace, light) {
    var block = workspace.getBlockById(BLOCK_ID),
        blockFill = getBlockFill(block),
        shadow = workspace.getBlockById(SHADOW_ID),
        shadowFill = getBlockFill(shadow),
        rgb = goog.color.hexToRgb(blockFill),
        lightenedRbg = goog.color.lighten(rgb, light),
        lightenedColor = goog.color.rgbArrayToHex(lightenedRbg);
    assert.equal(shadowFill, lightenedColor);
}

suite('kwc-blockly shadow color', function () {

    test('Use 0.6 by default', function () {
        var element = fixture('basic');
        element.loadBlocks(XML);
        var workspace = element.getWorkspace();
        assertShadowColor(workspace, 0.6);
    });
    
    test('Use workspace defined shadow light', function () {
        var element = fixture('shadow-workspace');
        element.loadBlocks(XML);
        var workspace = element.getWorkspace();
        assertShadowColor(workspace, 0.3);
    });

    test('Use block defined shadow light', function () {
        var element = fixture('shadow-workspace');
        Blockly.Blocks.math_number.shadowLight = 0.1;
        element.loadBlocks(XML);
        var workspace = element.getWorkspace();
        assertShadowColor(workspace, 0.1);
    });

});
</script>